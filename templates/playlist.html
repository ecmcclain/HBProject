{% extends 'base.html' %}

{% block title %}Play - Details{% endblock %}

{% block body %}

<nav class = "navbar fixed-bottom">
  <div class="container">
    <div class="btn-group" role="group" id="navigate" style="display: none;">
      <button type="button" id="togglePrevious">Previous</button>
      <button type="button" id="togglePlay">Pause</button>
      <button type="button" id="toggleNext">Next</button>
    </div>
  </div>
</nav>

<h1>{{ playlist.title }}</h1>


<a href='/refresh-token' id="re-auth" style="display: none;">Please click here to re-authenticate Spotify.</a>

<div class="btn-group navbar-brand" role="group">
  <button id="loadPlaylist" class="btn btn-outline-primary">Play All </button>
</div>
<div class="btn-group navbar-brand" role="group">
  <form action = /export_playlist method = 'POST'> 
    {% if '&' in playlist.title %} 
      <button type="submit" class="btn btn-outline-primary" name="playlist_id_shared" value="{{ playlist.id }}"> Export Playlist to Spotify</button>
    {% endif %}
    {% if '&' not in playlist.title %} 
      <button type="submit" class="btn btn-outline-primary" name="playlist_id_solo" value="{{ playlist.id }}"> Export Playlist to Spotify</button>
    {% endif %}
  </form>
</div>


<div class="fluid-container">
  <div class="row">
    
    <div class="col">
      <h2> Tracks</h2>
      <ol>
      {% for track in playlist.tracks %}
      <li>     <button id="{{track.spotify_track_id}}">Play</button>      {{ track.title }}, {{ track.artist }}</li>
      {% endfor %}
      </ol>
    </div>

</div>  

<br>
<br>
<br>


</div>

<script src="https://sdk.scdn.co/spotify-player.js"></script>
<script>
  window.onSpotifyWebPlaybackSDKReady = () => {
      const token = '{{ access_token }}';
      const player = new Spotify.Player({
          name: 'Web Playback SDK Quick Start Player',
          getOAuthToken: cb => { cb(token); },
          volume: 0.5
      });
      
      // Ready
      player.addListener('ready', ({ device_id }) => {
          console.log('Ready with Device ID', device_id);

          const connect_to_device = () => {
            console.log("Changing to device");
            let change_device = fetch("https://api.spotify.com/v1/me/player", {
              method: "PUT",
              body: JSON.stringify({
                device_ids: [device_id],
                play: false,
              }),
              headers: new Headers({
                Authorization: "Bearer " + token,
              }),
            }).then((response) => console.log(response));
            };
          
          connect_to_device();

          const handle_shuffle = () => {
            console.log("Handling shuffle");
            let change_device = fetch("https://api.spotify.com/v1/me/player/shuffle", {
              method: "PUT",
              body: JSON.stringify({
                state: false,
                device_id: device_id,
              }),
              headers: new Headers({
                Authorization: "Bearer " + token,
              }),
            }).then((response) => console.log(response));
            };
        
          handle_shuffle();
          });

      // Not Ready
      player.addListener('not_ready', ({ device_id }) => {
          console.log('Device ID has gone offline', device_id);
      });

      player.addListener('initialization_error', ({ message }) => {
          console.error(message);
      });

      player.addListener('authentication_error', ({ message }) => {
          console.error(message);
          document.getElementById('re-auth').style.display = "block";
      });

      player.addListener('account_error', ({ message }) => {
          console.error(message);
      });

      document.getElementById('togglePlay').onclick = function() {
        player.togglePlay();
        const play = document.getElementById('togglePlay');
        if (play.innerHTML == "Play"){
          play.childNodes[0].nodeValue = "Pause";
        }
        else {
          play.childNodes[0].nodeValue = "Play";
        }
      };
      
      document.getElementById('togglePrevious').onclick = function() {
        player.previousTrack()
        const play = document.getElementById('togglePlay');
        if (play.innerHTML == "Play"){
          play.childNodes[0].nodeValue = "Pause";
        }
        else {
          play.childNodes[0].nodeValue = "Play";
        }
      };

      document.getElementById('toggleNext').onclick = function() {
        player.nextTrack();
        const play = document.getElementById('togglePlay');
        if (play.innerHTML == "Play"){
          play.childNodes[0].nodeValue = "Pause";
        }
        else {
          play.childNodes[0].nodeValue = "Play";
        }
      };

      const playlistTracks = JSON.parse('{{ playlist_tracks | tojson }}');

      URIs = []
      for (const track of playlistTracks) {
        URIs.push('spotify:track:'+track);
      }

      document.getElementById('loadPlaylist').onclick = function() {
        const update_queue = () => {
            console.log("Updating the queue");
            let update_queue = fetch("https://api.spotify.com/v1/me/player/play", {
              method: "PUT",
              body: JSON.stringify({
                uris: URIs,
              }),
              headers: new Headers({
                Authorization: "Bearer " + token,
              }),
            }).then((response) => console.log(response));
            };
        update_queue();

        const navigate=document.getElementById('navigate');
        navigate.style.display = "block";

        player.togglePlay();
      };

      for (const [index,track] of playlistTracks.entries()) {
        const tempURIs = URIs.slice(index).concat(URIs.slice(0,index));
        const trackID = track;
        document.getElementById(trackID).onclick = function() {
        const update_queue = () => {
            console.log("Updating the queue");
            let update_queue = fetch("https://api.spotify.com/v1/me/player/play", {
              method: "PUT",
              body: JSON.stringify({
                uris: tempURIs,
              }),
              headers: new Headers({
                Authorization: "Bearer " + token,
              }),
            }).then((response) => console.log(response));
            };
        update_queue();

        const navigate=document.getElementById('navigate');
        navigate.style.display = "block";

        player.togglePlay();
      };
      }


      player.connect();
  }
</script>

{% endblock %}